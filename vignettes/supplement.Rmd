---
title: "Downscaling snowpack variability in western North America"
subtitle: "Models and Observations"
author: "Nick Gauthier"
date: "Last knit on: `r Sys.Date()`"
output:
  tufte::tufte_html: default
  tufte::tufte_handout:
    citation_package: natbib
    latex_engine: xelatex
  tufte::tufte_book:
    citation_package: natbib
    latex_engine: xelatex
link-citations: yes
---

Downscaling snow water equivalent 

# Introduction


Import the packages required for this analysis.

```{r setup}
knitr::opts_chunk$set(fig.width = 6, fig.asp = 0.618)

# analysis
library(remote) # empirical orthogonal teleconnections
library(tidyverse) # data manipulation and visualization
library(mgcv) # flexible nonlinear regression models
library(modelr)
library(MuMIn)
library(stars)

# plotting
library(sf) # shapefiles and plotting
library(scico) # color palettes
library(patchwork) # multi-panel plots
library(ggridges) # ridge plots
library(smoothr) # smooth contours on maps

# this package
devtools::load_all()

sf_use_s2(TRUE) # use s2 spherical geometry

load('../R/sysdata.rda')
```
 
# Snowpack in the western US
 
First plot March SWE climatology from observations and reanalysis data. We immediately see the mismatch between the two because of the coarse resolution reanalysis. To drive home the point, here's the high-resolution observations, resampled to the reanalysis resolution. For a better comparison, each dataset was reduced to the common range of 1982--2010. The coarse data fail to capture the topographic heterogeneity of the domain, and thus the small-scale variations in elevation and temperature that influence snow accumulation and melt.

```{r, fig.width = 7, fig.asp = .7, echo = FALSE, fig.cap="A) Mean March SWE from PRISM/SNOTEL observations, 1982-2017. B) Mean March SWE from CERA-20C Reanalysis, 1901-2010."}
a <- ggplot() +
  geom_stars(data = get_climatology(prism)) +
  geom_sf(data = states_wus, fill = NA, color = 'black') +
   scale_fill_distiller(palette = 'Blues', direction = 1, na.value = NA, name = 'SWE\n(mm)') +
  labs(x = 'Longitude', y = 'Latitude') +
  theme_bw()

b <- ggplot() +
  geom_stars(data = get_climatology(filter(cera, time > 1980))) +
  geom_sf(data = states_wus, fill = NA, color = 'black') +
   scale_fill_distiller(palette = 'Blues', direction = 1, na.value = NA, name = 'SWE\n(mm)', limits = c(0, 343)) +
  theme_void()

c <- ggplot() +
  geom_stars(data = get_climatology(filter(cesm, time > 1980))) +
  geom_sf(data = states_wus, fill = NA, color = 'black') +
   scale_fill_distiller(palette = 'Blues', direction = 1, na.value = NA, name = 'SWE\n(mm)', limits = c(0, 343)) +
  theme_void() 

d <- ggplot() +
  geom_stars(data = get_climatology(filter(ccsm, time > 1980))) +
  geom_sf(data = states_wus, fill = NA, color = 'black') +
   scale_fill_distiller(palette = 'Blues', direction = 1, na.value = NA, name = 'SWE\n(mm)', limits = c(0, 343)) +
  theme_void() 


(a + (b / d / c + plot_layout(guides = 'collect') )) + plot_layout( widths = c(1.5,1)) +  plot_annotation(tag_levels = 'a', tag_prefix = '(', tag_suffix = ')')& theme(legend.position = 'bottom')
```

```{r}
ggsave('swe_comparison.png', width = 7, height = .7 * 7, dpi = 600)
```


Next we'll look at how SWE has varied over time and space.


# Modes of Snowpack Variability

In spite of the mismatch in mean values, perhaps the *variability* in SWE from year to year has something in common.

## PCA

We can decompose all this year-to-year variability into the dominant spatial modes -- robust spatial anomaly patterns that tend to co-occur.

Run a principal components analysis. Get the eigenvalues, and run some truncation tests. Note these are each captured on the full time span of each dataset. So 32 years for prism, 

```{r, echo = FALSE}
e <- prism %>%
  get_pcs() %>%
  get_eigenvalues() %>% 
  plot_scree(k = 4, kmax = 10) +
  scale_color_brewer(palette = 'Spectral')

f <- cera %>% 
  get_pcs() %>%
  get_eigenvalues() %>% 
  plot_scree(k = 4, kmax = 10) +
  scale_color_brewer(palette = 'Spectral')
                      
g <- cesm %>% 
  get_pcs() %>%
  get_eigenvalues() %>% 
  plot_scree(k = 4, kmax = 10) +
  scale_color_brewer(palette = 'Spectral')

h <- ccsm %>% 
  get_pcs() %>%
  get_eigenvalues() %>% 
  plot_scree(k = 4, kmax = 10) +
  scale_color_brewer(palette = 'Spectral')

e + f + g + h + plot_annotation(tag_levels = 'A')
```

```{r echo = FALSE}
ggsave('eigenvalues.png', width = 8, height = 3.2)
```


## EOFs

So let's stick with the 4 and 4 solution, and investigate those patterns more. 
Lets start by truncating at 4. Extract the pc amplitude time series and EOF spatial patterns for the leading 4 modes.

```{r}
n_modes <- 4
```

```{r}
prism_patterns <- get_patterns(prism, k = n_modes)
cera_patterns <- get_patterns(cera, k = n_modes)
cesm_patterns <- get_patterns(cesm, k = n_modes)
ccsm_patterns <- get_patterns(ccsm, k = n_modes)
```

```{r}
ggplot() +
  geom_stars(data = get_patterns(prism, k = n_modes, scale = TRUE)$eofs) +
  facet_wrap(~PC) +
  scale_fill_scico(palette = 'vik', na.value = NA) +
  geom_sf(data = states_wus, fill = NA) +
  theme_bw()


ggplot() +
  geom_stars(data = get_patterns(prism, k = 6, scale = TRUE, rotate = TRUE)$eofs %>% split('PC') %>% mutate(PC1 = PC1 * -1, PC2 = PC2 * -1, PC3 = PC3 * -1, PC5 = PC5 * -1, PC6 = PC6 * -1) %>% merge(name = 'PC')) +
  facet_wrap(~PC) +
  scale_fill_viridis_c(na.value = NA) +
  #scale_fill_scico(palette = 'vik', na.value = NA) +
  geom_sf(data = states_wus, fill = NA) +
  theme_bw()

ggplot() +
  geom_stars(data = get_patterns(cera, k = n_modes, scale = TRUE)$eofs) +
  facet_wrap(~PC) +
  scale_fill_scico(palette = 'vik', na.value = NA) +
  geom_sf(data = states_wus, fill = NA) +
  theme_bw()

ggplot() +
  geom_stars(data = get_patterns(ccsm, k = n_modes, scale = TRUE)$eofs) +
  facet_wrap(~PC) +
  scale_fill_scico(palette = 'vik', na.value = NA) +
  geom_sf(data = states_wus, fill = NA) +
  theme_bw()

ggplot() +
  geom_stars(data = get_patterns(cesm, k = n_modes, scale = TRUE)$eofs) +
  facet_wrap(~PC) +
  scale_fill_scico(palette = 'vik', na.value = NA) +
  geom_sf(data = states_wus, fill = NA) +
  theme_bw()


ggplot() +
  geom_stars(data = get_patterns(prism_clim['tmean'], k = n_modes, scale = TRUE)$eofs) +
  facet_wrap(~PC) +
  scale_fill_scico(palette = 'vik', na.value = NA) +
  geom_sf(data = states_wus, fill = NA) +
  theme_bw()
```



```{r, echo = FALSE}
plot_amps(prism_patterns) + geom_hline(yintercept = 0, linetype = 2) + geom_vline(xintercept = 1997)
plot_amps(cera_patterns) + geom_hline(yintercept = 0, linetype = 2) 
plot_amps(cesm_patterns)
plot_amps(ccsm_patterns)
```
Plot the EOFs
```{r}
plot_eofs(prism_patterns, scaled = FALSE)
plot_eofs(cera_patterns, scaled = FALSE)
plot_eofs(cesm_patterns, scaled = FALSE)
plot_eofs(ccsm_patterns, scaled = FALSE)
```

Visualize the leading EOFs as correlation coefficients.
```{r, fig.width = 7, fig.asp = .875}
swe_corr_prism <- prism %>%
  rename(value = SWE) %>%
  get_correlation(prism_patterns)

swe_corr_cera <- cera_dat %>%
  rename(value = SWE) %>%
  get_correlation(cera_patterns)

swe_corr_ccsm <- ccsm_dat %>%
  rename(value = SWE) %>%
  get_correlation(ccsm_patterns)

a <- swe_corr_prism %>%
  gather(PC, value, PC1:PC4) %>%
ggplot() +
  geom_raster(aes(x, y, fill = value)) +
        geom_sf(data = states_wus, fill = NA, color = 'black') +
  facet_wrap(~PC, nrow = 1) +
scale_fill_scico(palette = 'broc', limits = c(-1, 1), name = 'Correlation') +
    labs(x = 'Longitude', y = 'Latitude') +
  theme_void()

b <- swe_corr_cera %>%
  mutate(PC1 = PC1 * -1, PC2 = PC2 * -1, PC4 = PC4 * -1) %>% # the signs are arbitrary, so adjust the cera signs so the colors match prism
  gather(PC, value, PC1:PC4) %>%
ggplot() +
  geom_raster(aes(x, y, fill = value)) +
        geom_sf(data = states_wus, fill = NA, color = 'black') +
  facet_wrap(~PC, nrow = 1) +
scale_fill_scico(palette = 'broc', limits = c(-1, 1), name = 'Correlation') +
    labs(x = 'Longitude', y = 'Latitude') +
  theme_void()

c <- swe_corr_ccsm %>%
  remove_missing() %>%
  mutate(PC1 = PC1 * -1,
         PC2 = PC2 * -1,
         PC3 = PC3 * -1) %>% # the signs are arbitrary, so adjust the cera signs so the colors match prism
  gather(PC, value, PC1:PC4) %>%
ggplot() +
  geom_raster(aes(x, y, fill = value)) +
        geom_sf(data = states_wus, fill = NA, color = 'black') +
  facet_wrap(~PC, nrow = 1) +
scale_fill_scico(palette = 'broc', limits = c(-1, 1), name = 'Correlation') +
    labs(x = 'Longitude', y = 'Latitude') +
  theme_void()

(a / b / c) + plot_layout(guides = 'collect') + plot_annotation(tag_levels = 'A') & theme(legend.position = 'bottom')
```

```{r}
ggsave('eofs.png', height = 6, width = 7, dpi = 600)
```


## Teleconnections

Calculate the correlation between the leading 4 patterns and regional precipitation, temperature, geopotential, and SST.
```{r}
ppt_corr <- get_correlation(prism_clim['ppt'], prism_patterns)
tmean_corr <- get_correlation(prism_clim['tmean'], prism_patterns)
```

Also calculate the false discovery rate, and generate points where < 0.1.
```{r}
ppt_sig <- get_fdr(prism_clim['ppt'], prism_patterns) %>%
  drop_crumbs(units::set_units(100, km))  %>% 
  smooth(method = 'ksmooth', smoothness = 5)
tmean_sig <- get_fdr(prism_clim['tmean'], prism_patterns) %>%
  drop_crumbs(units::set_units(100, km))  %>% 
  smooth(method = 'ksmooth', smoothness = 5)
```

Plot the results.

```{r}
e <- ggplot() +
  geom_stars(data = ppt_corr) +
   geom_sf(data = ppt_sig, alpha = 0.65) +
    facet_wrap(~paste0(PC, '-Precipitation'), nrow = 1) +
    geom_sf(data = states_wus, fill = NA, color = 'black') +
  scale_fill_scico(palette = 'vikO', limits = c(-1, 1), name = 'Correlation', na.value = NA) +
  labs(x = 'Longitude', y = 'Latitude') +
  theme_void()

f <- ggplot() +
  geom_stars(data = tmean_corr) +
   geom_sf(data = tmean_sig, alpha = 0.65) +
    geom_sf(data = states_wus, fill = NA, color = 'black') +
  facet_wrap(~paste0(PC, '-Temperature'), nrow = 1) +
  scale_fill_scico(palette = 'vikO', limits = c(-1, 1), name = 'Correlation', na.value = NA) +
  labs(x = 'Longitude', y = 'Latitude') +
  theme_void()

prism_tele <- (e/f) + plot_layout(guides = 'collect') + plot_annotation(tag_levels = 'a', tag_prefix = '(', tag_suffix = ')') & theme(legend.position = 'bottom')
prism_tele
```

```{r}
ggsave('prism_teleconnections.png', prism_tele, width = 12, height = 12 * 0.618)
```



```{r}
sst_corr <- get_correlation(st_warp(sst, dest = ref), prism_patterns) # change names
geop_corr <- get_correlation(st_warp(geop, dest = ref), prism_patterns) # change names

sst_sig <- get_fdr(st_warp(sst, dest = ref), prism_patterns) %>% 
  smooth(method = 'ksmooth', smoothness = 5)
geop_sig <- get_fdr(st_warp(geop, dest = ref), prism_patterns) %>% 
  smooth(method = 'ksmooth', smoothness = 5)
```


```{r, fig.asp = .4}
i <- ggplot() +
  geom_stars(data = geop_corr) +
  geom_sf(data = world, fill = 'grey20', color = NA, alpha = 0.35) +
     geom_sf(data = geop_sig, alpha = 0.65) +
  facet_wrap(~paste0(PC, '-Geopotential'), nrow = 1) +
  scale_fill_scico(palette = 'vikO', limits = c(-1, 1), name = 'Correlation', na.value = NA) +
 # coord_sf(ylim = c(-75,75), expand = FALSE) +
    #coord_sf(crs = '+proj=moll +lon_0=-150', ylim = c(-7500000, 7500000)) +
#  labs(x = 'Longitude', y = 'Latitude') +
  theme_void()# +
  #theme(panel.border = element_rect(fill = NA, 
                                #    colour = "grey20"), panel.spacing = unit(0, "lines"))

j <- ggplot() +
  geom_stars(data = sst_corr) +
    #  geom_sf(data = sst_sig, alpha = 0.65) +
  facet_wrap(~paste0(PC, '-SST'), nrow = 1) +
  scale_fill_scico(palette = 'vikO', limits = c(-1, 1), name = 'Correlation', na.value = NA) +
  geom_sf(data = world, fill = 'grey20', color = NA) +
   #   coord_sf(crs = '+proj=moll +lon_0=180') +
  #coord_sf(expand = FALSE) +
  theme_void()
  #theme(panel.border = element_rect(fill = NA, 
   #                                colour = "grey20"), panel.spacing = unit(1, "lines"))

cera_tele <- (i/j) + plot_layout(guides = 'collect') + plot_annotation(tag_levels = 'a', tag_prefix = '(', tag_suffix = ')') & theme(legend.position = 'bottom')

cera_tele
```


```{r}
ggsave('cera_teleconnections.png', cera_tele, width = 12, height = 12 * 0.4)
```
```


```{r}
ggsave('snow_teleconnections2.png', width = 10.5, height = 6, dpi = 600)
```

# Coupled Pattern Analysis


## Cross-validation

Set up a 5 fold cross validation experiment for selecting the truncation level, $k$, for each set of PCs.

```{r, warning = FALSE}
cv_eot_data <- prep_eot(cera, prism, 10, 10, 10)
```


```{r, warning = FALSE, message = FALSE}
cv_eot <- tibble(k = 1:10) %>%
  mutate(pred = purrr::map(k, predict_eot, cv = cv_eot_data),
         error = purrr::map(pred, cv_eot_error, obs = prism)) %>%
  select(k, error) %>%
  unnest_wider(error)
```

```{r}
cv_cca <- expand_grid(kx = 1:10, ky = 1:10, kxy = 1:10) %>%
  filter(kxy <= pmin(kx, ky)) %>%
  mutate(cv = pmap(list(kx, ky, kxy), ~prep_cca(..1, ..2, 
                                                preds = cera, 
                                                obs = prism) %>% 
                     fit_cv(fun = predict_cca, k = ..3, prism))) %>%
  unnest_wider(cv)
```


```{r message=FALSE}
# does this work for gams too?
cv_pcr <- expand_grid(kx = 1:10, ky = 1:10) %>%
  mutate(cv = map2(kx, ky, ~prep_cca(.x, .y, preds = cera, obs = prism) %>% 
                     fit_cv(fun = predict_pcr, k = .y, obs = prism))) %>%
  unnest_wider(cv)
```

```{r}
# does this work for gams too?
cv_gam <- expand_grid(kx = 1:10, ky = 1:10) %>%
  mutate(cv = map2(kx, ky, ~prep_cca(.x, .y, preds = cera, obs = prism) %>% 
                     fit_cv(fun = predict_gam, k = .y, obs = prism))) %>%
  unnest_wider(cv)
```

```{r}
cv_delta_mul <- prep_delta(cera_raw, prism) %>%
   fit_cv(fun = delta, k = NULL, obs = prism) # poor performance because of multiplicative anomalies

cv_delta_add <- prep_delta(cera_raw, prism) %>%
   fit_cv(fun = delta_add, k = NULL, obs = prism)
```


```{r}
write_csv(cv_eot, 'cv_eot.csv')
write_csv(cv_cca, 'cv_cca.csv')
write_csv(cv_pcr, 'cv_pcr.csv')
write_csv(cv_gam, 'cv_gam.csv')
```


```{r}
cv_cca <- read_csv('cv_cca.csv')
cv_eot <- read_csv('cv_eot.csv')
cv_gam <- read_csv('cv_pcr.csv')
cv_pcr <- read_csv('cv_gam.csv')
```

```{r, fig.asp = .4}
a <- cv_cca %>%
  group_by(kxy) %>%
  filter(rmse == min(rmse)) %>%
  rename(k = kxy) %>%
  bind_rows(cv_eot, .id = 'Method') %>%
  mutate(Method = if_else(Method == '1', 'CCA', 'EOT')) %>%
  ggplot(aes(k, rmse)) +
  geom_hline(yintercept = cv_delta_add[[1]], linetype = 2, alpha = 0.75) +
  geom_line(aes(group = Method, color = Method), size = 1.2) +
scale_color_grey() +
  theme_bw() +
    scale_x_continuous(breaks = 1:10, minor_breaks = NULL) +
    labs(x = 'Coupled patterns', y = 'RMSE (mm)')

b <- cv_cca %>%
  group_by(kxy) %>%
  filter(corr == max(corr)) %>%
  rename(k = kxy) %>%
  bind_rows(cv_eot, .id = 'Method') %>%
    mutate(Method = if_else(Method == '1', 'CCA', 'EOT')) %>%
  ggplot(aes(k, corr)) +
    geom_hline(yintercept = cv_delta_add[[2]], linetype = 2, alpha = 0.75) +
  geom_line(aes(group = Method, color = Method), size = 1.2) +
scale_color_grey() +
  theme_bw() +
    scale_x_continuous(breaks = 1:10, minor_breaks = NULL) + 
  labs(x = 'Coupled patterns', y = 'Domain-wide correlation')

a + b + plot_layout(guides = 'collect') + plot_annotation(tag_levels = 'A')
```

```{r}
ggsave('method_comparison.png', height = 2.4, width = 6, dpi = 600)
```


The cross validation routine selects `r arrange(cv_cca, rmse)[[1, 'ky']]` PRISM PCs,  `r arrange(cv_cca, rmse)[[1, 'kx']]` CERA PCs, and `r arrange(cv_cca, rmse)[[1, 'kxy']]` combined patterns for the best spatial skill.

The cross validation routine selects `r arrange(cv_cca, -corr)[[1, 'ky']]` PRISM PCs,  `r arrange(cv_cca, -corr)[[1, 'kx']]` CERA PCs, and `r arrange(cv_cca, -corr)[[1, 'kxy']]` combined patterns for the best domain-wide temporal skill.

```{r}
arrange(cv_cca, rmse)
arrange(cv_cca, -corr)
arrange(cv_eot, rmse)
arrange(cv_eot, -corr)
arrange(cv_pcr, rmse)
arrange(cv_pcr, -corr)
arrange(cv_gam, rmse)
arrange(cv_gam, -corr)
```


```{r}
cv_cca %>%
  group_by(kxy) %>%
  filter(corr == max(corr)) %>%
  ungroup()%>%
  arrange(kxy) %>%
  mutate(test = corr >= lead(corr))

cv_eot %>%
  arrange(k) %>%
  mutate(test = corr >= lead(corr))

cv_cca %>%
  group_by(kxy) %>%
  filter(rmse == min(rmse)) %>%
  ungroup() %>%
  arrange(kxy) %>%
  mutate(test = (rmse <= lead(rmse)))

cv_eot %>%
  arrange(k) %>%
  mutate(test = (rmse <= lead(rmse)))
```

```{r, fig.width=8}
a <- cv_cca %>%
  group_by(kxy, kx) %>%
  summarise(rmse = min(rmse)) %>% 
    ggplot(aes(kx, kxy)) +
  geom_tile(aes(fill = rmse)) +
  scale_fill_viridis_c(direction = -1, limits = c(41.4, 54.69), breaks = seq(42, 54, 3), name = 'RMSE') +
  theme_minimal() +
  scale_x_continuous(breaks = 1:10, minor_breaks = NULL) +
  scale_y_continuous(breaks = 1:10, minor_breaks = NULL) +
  coord_fixed()

b <- cv_cca %>%
  group_by(kxy, ky) %>%
  summarise(rmse = min(rmse)) %>% 
    ggplot(aes(ky, kxy)) +
  geom_tile(aes(fill = rmse)) +
  scale_fill_viridis_c(direction = -1, limits = c(41.4, 54.69), breaks = seq(42, 54, 3), name = 'RMSE') +
  theme_minimal() +
  scale_x_continuous(breaks = 1:10, minor_breaks = NULL) +
  scale_y_continuous(breaks = 1:10, minor_breaks = NULL) +
  coord_fixed()

c <- cv_cca %>%
  group_by(kx, ky) %>%
  summarise(rmse = min(rmse)) %>% 
    ggplot(aes(kx, ky)) +
  geom_tile(aes(fill = rmse)) +
  scale_fill_viridis_c(direction = -1, limits = c(41.4, 54.69), breaks = seq(42, 54, 3), name = 'RMSE') +
  theme_minimal() +
  scale_x_continuous(breaks = 1:10, minor_breaks = NULL) +
  scale_y_continuous(breaks = 1:10, minor_breaks = NULL) +
  coord_fixed()

d <- cv_cca %>%
  group_by(kxy, kx) %>%
  summarise(corr = max(corr)) %>% 
    ggplot(aes(kx, kxy)) +
  geom_tile(aes(fill = corr)) +
  scale_fill_viridis_c(option = 'magma', direction = 1, limits = c(0.7677, 0.9405), name = 'Cor.') +
  theme_minimal() +
  scale_x_continuous(breaks = 1:10, minor_breaks = NULL) +
  scale_y_continuous(breaks = 1:10, minor_breaks = NULL) +
  coord_fixed()

e <- cv_cca %>%
  group_by(kxy, ky) %>%
  summarise(corr = max(corr)) %>%
    ggplot(aes(ky, kxy)) +
  geom_tile(aes(fill = corr)) +
  scale_fill_viridis_c(option = 'magma', direction = 1, limits = c(0.7677, 0.9405), name = 'Cor.') +
  theme_minimal() +
  scale_x_continuous(breaks = 1:10, minor_breaks = NULL) +
  scale_y_continuous(breaks = 1:10, minor_breaks = NULL) +
  coord_fixed()

f <- cv_cca %>%
  group_by(kx, ky) %>%
  summarise(corr = max(corr)) %>% 
    ggplot(aes(kx, ky)) +
  geom_tile(aes(fill = corr)) +
  scale_fill_viridis_c(option = 'magma', direction = 1, limits = c(0.7677, 0.9405), name = 'Cor.') +
  theme_minimal() +
  scale_x_continuous(breaks = 1:10, minor_breaks = NULL) +
  scale_y_continuous(breaks = 1:10, minor_breaks = NULL) +
  coord_fixed()

(a + b + c + plot_layout(guides = 'collect')) / (d + e + f + plot_layout(guides = 'collect')) + plot_annotation(tag_levels = 'a', tag_prefix = '(', tag_suffix = ')')
```

```{r}
ggsave('cca_cv.png', width = 8, height = 4.944, dpi = 600)
```

# Reconstruction

```{r}
# k's here could be taken directly from the CV results above
recon_20c_time <- predict_cca(get_patterns(filter(cera, time >= 1982), 5), 
            get_patterns(filter(prism, time <= 2010), 8), 
            cera,
            k = 5)

recon_20c_space <- predict_cca(get_patterns(filter(cera, time >= 1982), 10), 
            get_patterns(filter(prism, time <= 2010), 9), 
            cera,
            k = 7)
```

```{r}
wus_stats <- get_total(prism)

cera_baseline <- get_total(cera)

recon_series <- get_total(recon_20c_time)

ccsm_series <- predict_cca(get_patterns(filter(cera, time >= 1982), 5), 
            get_patterns(filter(prism, time <= 2010), 8), 
            ccsm %>% filter(time >= 1700),
            k = 5) %>%
  get_total()

ccsm_series_raw <- get_total(ccsm) %>% filter(time > 1700)
```

```{r fig.width=6.5}
recon_series %>%
  ggplot(aes(time, as.numeric(SWE))) +
    geom_line(data = cera_baseline, aes(color = 'grey'), size = 1.1) +
  geom_line(size = 1.1, aes(color = 'black')) +
  geom_line(data = wus_stats, aes(color = 'red'), size = 1.1, alpha = .7) +
  scale_color_identity(name = NULL,
                          breaks = c("red", "grey", "black"),
                          labels = c("Observations", 'Reanalysis', 'Downscaled Reanalysis'),
                          guide = "legend") +
  labs(x = 'Year', y = 'Total SWE (TL)') +
  theme_bw() +
  theme(legend.position = 'bottom')
```

```{r}
ggsave('20c_recon.png', height = .6 * 6.5, width = 6.5, dpi = 600)
```


```{r, fig.width = 6, fig.height = 4}
bind_rows('ccsm_recon' = ccsm_series,
          'ccsm_raw' = ccsm_series_raw, .id = 'type') %>%
  filter(time < 2000) %>%
  mutate(period = floor(time / 50) * 50) %>%
  ggplot(aes(as.numeric(SWE), fct_rev(as_factor(period)))) +
  geom_density_ridges(alpha = .8, aes(group = interaction(period, type), fill = type)) +
  scale_fill_manual(name = NULL,
                          values = c('lightgrey', "darkgrey"),
                          labels = c("Raw CCSM4", 'Downscaled CCSM4'),
                         guide = "legend") +
  geom_vline(xintercept= as.numeric(mean(wus_stats$SWE) ), linetype = 2) +
  ggridges::theme_ridges(grid = FALSE, center_axis_labels = TRUE) +
  labs(x = 'Total SWE (TL)', y = 'Period')
```

```{r}
ggsave('ccsm4_comparison.png', height = 4, width = 6, dpi = 600)
```


```{r fig.width = 6.5, fig.asp = .5}
cera_anomaly <- cera %>%
  filter(between(time, 1982, 2010)) %>%
  units::drop_units() %>%
  `-`(get_climatology(filter(cera, between(time, 1982, 2010)))['mean']) %>%
  `/`(get_climatology(filter(cera, between(time, 1982, 2010)))['sd']) %>%
  filter(time == 1997) 

recon_anomaly <- recon_20c_space %>%
  filter(between(time, 1982, 2010)) %>%
  units::drop_units() %>%
  `-`(get_climatology(filter(recon_20c_space, between(time, 1982, 2010)))['mean']) %>%
  `/`(get_climatology(filter(recon_20c_space, between(time, 1982, 2010)))['sd']) %>%
  filter(time == 1997) 

prism_anomaly <- prism %>%
  filter(between(time, 1982, 2010)) %>%
  units::drop_units() %>%
  `-`(get_climatology(filter(prism, between(time, 1982, 2010)))['mean']) %>%
  `/`(get_climatology(filter(prism, between(time, 1982, 2010)))['sd']) %>%
  filter(time == 1997) 

a <- ggplot() +
  geom_stars(data = cera_anomaly) +
  geom_sf(data = states_wus, fill = NA, color = 'black') +
  scale_fill_scico(palette = 'vik', direction = -1, limits = c(-5.2,5.2), name =  'Standard deviations', na.value = NA) +
  theme_void()

b <-  ggplot() +
  geom_stars(data = recon_anomaly) +
  geom_sf(data = states_wus, fill = NA, color = 'black') +
  scale_fill_scico(palette = 'vik', direction = -1, limits = c(-5.2, 5.2), name =  'Standard deviations', na.value = NA) +
  theme_void()

c <- ggplot() +
  geom_stars(data = prism_anomaly)  +
  geom_sf(data = states_wus, fill = NA, color = 'black') +
  scale_fill_scico(palette = 'vik', direction = -1, limits = c(-5.2, 5.2), name = 'Standard deviations', na.value = NA) +
  theme_void()

a + b + c + plot_layout(guides = 'collect') + plot_annotation(tag_levels = 'A') & theme(legend.position = 'bottom')
```
```{r}
ggsave('anomalies_1997.png', height = 3.25, width = 6.5, dpi = 600)
```
