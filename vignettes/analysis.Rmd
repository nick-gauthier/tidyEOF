---
title: "Downscaling snowpack variability in western North America"
subtitle: "Models and Observations"
author: "Nick Gauthier"
date: "Last knit on: `r Sys.Date()`"
output:
  tufte::tufte_html: default
  tufte::tufte_handout:
    citation_package: natbib
    latex_engine: xelatex
  tufte::tufte_book:
    citation_package: natbib
    latex_engine: xelatex
link-citations: yes
---

Downscaling snow water equivalent 

# Introduction


Import the packages required for this analysis.

```{r setup}
knitr::opts_chunk$set(fig.width = 6, fig.asp = 0.618)

# analysis
library(remote) # empirical orthogonal teleconnections
library(telefit) # cca
library(tidyverse) # data manipulation and visualization
library(mgcv) # flexible nonlinear regression models
library(modelr)

# plotting
library(sf) # shapefiles and plotting
library(gganimate) # animated gifs
library(magick) # for multi-panel animations
library(scico) # color palettes
library(patchwork)


# this package
devtools::load_all()

load('../data.Rdata')
```
 
# Snowpack in the western US
 
First plot March SWE climatology from observations and reanalysis data. We immediately see the mismatch between the two because of the coarse resolution reanalysis. To drive home the point, here's the high-resolution observations, resampled to the reanalysis resolution. For a better comparison, each dataset was reduced to the common range of 1982--2010. The coarse data fail to capture the topographic heterogeneity of the domain, and thus the small-scale variations in elevation and temperature that influence snow accumulation and melt.

```{r, echo = FALSE, fig.cap="A) Mean March SWE from PRISM/SNOTEL observations, 1982-2017. B) Mean March SWE from CERA-20C Reanalysis, 1901-2010."}
a <- prism_dat %>%
  get_climatology() %>%
  ggplot() +
  geom_raster(aes(x, y, fill = swe_mean)) +
  geom_sf(data = states_wus, fill = NA, color = 'black') +
   scale_fill_distiller(palette = 'Blues', direction = 1, name = 'SWE (mm)') +
  theme_void() +
  theme(legend.position = 'bottom')

b <- cera_dat %>%
  get_climatology() %>%
  ggplot() +
  geom_raster(aes(x, y, fill = swe_mean)) +
  geom_sf(data = states_wus, fill = NA, color = 'black') +
   scale_fill_distiller(palette = 'Blues', direction = 1, name = 'SWE (mm)') +
  theme_void() +
  theme(legend.position = 'bottom')

a + b + plot_annotation(tag_levels = 'A')
```

When were the max and min SWE years?
```{r}
prism_dat %>%
  group_by(x,y) %>%
  filter(SWE == max(SWE)) %>%
  ggplot() +
  geom_raster(aes(x, y, fill = year)) +
  geom_sf(data = states_wus, fill = NA, color = 'black') +
   scale_fill_viridis_c() +
  theme_void() +
  theme(legend.position = 'bottom')

prism_dat %>%
  group_by(x,y) %>%
  filter(SWE == min(SWE)) %>%
  ggplot() +
  geom_raster(aes(x, y, fill = year)) +
  geom_sf(data = states_wus, fill = NA, color = 'black') +
     scale_fill_viridis_c() +
  theme_void() +
  theme(legend.position = 'bottom')
```

Where are the snowy pixels?
```{r}
prism_dat %>%
  group_by(x,y) %>%
  summarise(median_swe = median(SWE)) %>%
  ggplot() +
    geom_raster(aes(x, y, fill = median_swe > 3)) +
  geom_sf(data = states_wus, fill = NA, color = 'black') +
   scale_fill_viridis_d() +
  theme_void() +
  theme(legend.position = 'bottom')
```


```{r}
prism_dat %>%
  ggplot(aes((SWE))) +
  geom_histogram()

prism_dat %>%
  group_by(x, y) %>%
  summarise(kurt =  e1071::kurtosis(SWE)) %>%
  ggplot() +
  geom_raster(aes(x, y, fill = kurt > 3)) +
  geom_sf(data = states_wus, fill = NA, color = 'black') +
  theme_void() +
  theme(legend.position = 'bottom')

prism_dat %>%
  group_by(x, y) %>%
  summarise(skew =  e1071::skewness(SWE)) %>%
  ggplot() +
  geom_raster(aes(x, y, fill = skew)) +
  geom_sf(data = states_wus, fill = NA, color = 'black') +
scale_fill_viridis_c() +
  theme_void() +
  theme(legend.position = 'bottom')
  
prism_dat %>%
  group_by(x, y) %>%
  summarise(p = shapiro.test(log(SWE + 1))$p) %>%
  ggplot() +
    geom_raster(aes(x, y, fill = p < 0.05)) +
  geom_sf(data = states_wus, fill = NA, color = 'black') +
  theme_void() +
  scale_fill_viridis_d() 
```

```{r}
# prism_dat %>%
#   get_climatology() %>%
#   ggplot() +
#   geom_raster(aes(x, y, fill = swe_mean)) +
#   geom_sf(data = states_wus, fill = NA, color = 'black') +
#   scale_fill_scico(palette = 'davos', direction = -1, name = 'SWE (mm)') +
#   theme_void() +
#   theme(legend.position = 'bottom') +
#       ggtitle("Mean March Snow Water Equivalent", "1982-2017")
# ggsave('swe_mean.png', height = 7, width = 7)
a <- prism_dat %>%
  get_climatology() %>%
  ggplot() +
  geom_raster(aes(x, y, fill = swe_mean)) +
  geom_sf(data = states_wus, fill = NA, color = 'black') +
  scale_fill_scico(palette = 'davos', direction = -1, name = 'SWE (mm)') +
  theme_void()

b <- cera_dat %>%
  get_climatology() %>%
  ggplot() +
  geom_raster(aes(x, y, fill = swe_mean)) +
  geom_sf(data = states_wus, fill = NA, color = 'black') +
  scale_fill_scico(palette = 'davos', direction = -1, name = 'SWE (mm)') +
  theme_void()

(a + b) + plot_annotation(tag_levels = 'A') & theme(legend.position = 'bottom')
ggsave('swe_comparison.png', width = 7, height = .61*7)
```

Next we'll look at how SWE has varied over time and space.


# Modes of Snowpack Variability

In spite of the mismatch in mean values, perhaps the *variability* in SWE from year to year has something in common.

```{r animation, echo = FALSE, warning=FALSE,cache = TRUE}
# code courtesy of https://github.com/thomasp85/gganimate/wiki/Animation-Composition
c <- prism_dat %>%
      filter(between(year, 1990, 2010)) %>%
  group_by(x, y) %>%
  mutate(anomaly = (SWE - mean(SWE)) / sd(SWE))  %>% 
  ggplot() +
  geom_raster(aes(x, y, fill = anomaly)) +
  geom_sf(data = states_wus, fill = NA, color = 'black') +
  scale_fill_scico(palette = 'vik', direction = -1, limits = c(-4.5, 4.5), name = 'Standard\n deviations') +
    transition_states(year) +
    ggtitle("March {closest_state} SWE anomaly", "Observed") +
  theme_void() +
  theme(legend.position = 'bottom')

d <- cera_dat %>%
      filter(between(year, 1990, 2010)) %>%
    group_by(x, y) %>%
    mutate(anomaly = (SWE - mean(SWE)) / sd(SWE)) %>%
  ggplot() +
  geom_raster(aes(x, y, fill = anomaly)) +
  geom_sf(data = states_wus, fill = NA, color = 'black') +
  scale_fill_scico(palette = 'vik', direction = -1, limits = c(-4.5, 4.5), name = 'Standard\n deviations') +
  transition_states(year) +
  ggtitle("", "Simulated") +
  theme_void() +
  theme(legend.position = 'bottom')

c_gif <- gganimate::animate(c)
d_gif <- gganimate::animate(d)

c_mgif <- image_read(c_gif)
d_mgif <- image_read(d_gif)

new_gif <- image_append(c(c_mgif[1], d_mgif[1]))
for(i in 2:100){
  combined <- image_append(c(c_mgif[i], d_mgif[i]))
  new_gif <- c(new_gif, combined)
}

new_gif

image_write(new_gif, 'anomalies.mp4')
```

## PCA

We can decompose all this year-to-year variability into the dominant spatial modes -- robust spatial anomaly patterns that tend to co-occur.

Run a principal components analysis. Get the eigenvalues, and run some truncation tests.

```{r, fig.width = 8, fig.asp = .4, echo = FALSE}
e <- prism_dat %>% 
  get_pcs() %>%
  get_eigenvalues() %>% 
  plot_scree(k = 4, kmax = 10) +
  scale_color_brewer(palette = 'Spectral')

f <- cera_dat %>% 
  get_pcs() %>%
  get_eigenvalues() %>% 
  plot_scree(k = 4, kmax = 10) +
  scale_color_brewer(palette = 'Spectral')

e + f + plot_annotation(tag_levels = 'A')
ggsave('eigenvalues.png', width = 8, height = 3.2)
```

```{r}
dof_p <- prism_dat %>% 
  get_pcs() %>%
  get_eigenvalues() %>%
  pull(eigenvalues)

sum(dof_p)^2 / sum(dof_p^2) # from bretheron et al 1999

dof_c <- cera_dat %>% 
  get_pcs() %>%
  get_eigenvalues() %>%
  pull(eigenvalues)

sum(dof_c)^2 / sum(dof_c^2) # from bretheron et al 1999
```

```{r}
# prism for the whole period
 prism_dat %>% 
  get_pcs() %>%
  get_eigenvalues() %>% 
  plot_scree(k = 4, kmax = 10) +
  scale_color_brewer(palette = 'Spectral')

# prism for before 2010
 prism_dat %>% 
   filter(year <=2010)%>%
  get_pcs() %>%
  get_eigenvalues() %>% 
  plot_scree(k = 4, kmax = 10) +
  scale_color_brewer(palette = 'Spectral')

 #cera after 1983
cera_dat %>% 
  filter(year>=1983) %>%
  get_pcs() %>%
  get_eigenvalues() %>% 
  plot_scree(k = 4, kmax = 10) +
  scale_color_brewer(palette = 'Spectral')

#cera whole
cera_dat %>% 
  get_pcs() %>%
  get_eigenvalues() %>% 
  plot_scree(k = 4, kmax = 10) +
  scale_color_brewer(palette = 'Spectral')
```

Looks like there are ~4 spatial degrees of freedom in the data

## EOFs

So let's stick with the 4 and 4 solution, and investigate those patterns more. 
Lets start by truncating at 4. Extract the pc amplitude time series and EOF spatial patterns for the leading 4 modes.

```{r}
n_modes <- 4
```

```{r}
prism_patterns <- get_patterns(prism_dat, k = n_modes)
cera_patterns <- get_patterns(cera_dat, k = n_modes)
```


```{r, echo = FALSE}
plot_amps(prism_patterns) + geom_hline(yintercept = 0, linetype = 2) 
plot_amps(cera_patterns) + geom_hline(yintercept = 0, linetype = 2) 
```

Plot the eofs. 
```{r echo = FALSE, fig.asp = 1}
plot_eofs(prism_patterns, 'vik', scaled = FALSE) 
plot_eofs(cera_patterns, 'vik', scaled = FALSE)
plot_eofs(prism_patterns, 'vik', scaled = TRUE) 
plot_eofs(cera_patterns, 'vik', scaled = TRUE)
```

```{r, fig.width = 8, fig.height = 8}
 get_patterns(prism_dat, k = 4, rotate = TRUE) %>% plot_eofs(scaled = FALSE) + ggtitle('REOFs')
ggsave('reofs.png',height = 8, width = 8)
```

```{r, fig.width = 8, fig.asp = .7}
prism_patterns$eofs_corr <- prism_patterns$eofs_corr %>% mutate(correlation = if_else(PC == 4, correlation, correlation * -1))

a<-plot_eofs(prism_patterns, 'vik', scaled = TRUE) + facet_wrap(~paste0('EOF', PC), nrow = 1) + ggtitle('Leading March SWE spatial modes', 'Observed') + theme(legend.position = 'bottom')

b<-plot_eofs(cera_patterns, 'vik', scaled = TRUE) + facet_wrap(~paste0('EOF', PC), nrow = 1) + ggtitle('', 'Simulated') + theme(legend.position = 'bottom')

c <- a / b & theme(legend.position = "bottom")
c + plot_layout(guides = "collect", heights = 1,1)
ggsave('eofs.png')
```

```{r}
# For each PC amplitude time series, plot out the wettest and driest years from the observations.
# From this we can tell that pc1 and 2 need to reverse signs to be physically consistent
extreme_years <- prism_patterns$amplitudes %>%
  group_by(PC) %>%
  filter(amplitude == max(amplitude) | amplitude == min(amplitude)) %>%
  pull(year)

(prism - mean(prism)) %>%
  .[[extreme_years - 1981]] %>%
  setNames(extreme_years) %>%
  as.data.frame(xy = TRUE, na.rm = TRUE) %>%
  gather(year, swe, 3:10) %>%
  mutate(year = factor(year, levels = paste0('X', extreme_years))) %>%
  ggplot(aes(x, y, fill = swe)) +
  geom_raster() +
  facet_wrap(~year) +
  coord_quickmap() +
  scale_fill_distiller(palette = 'BrBG', direction = 1, limits = c(-1500, 1500)) +
  theme_void()
```

## Internal variability

```{r, fig.asp = .9}
prism_recon <- reconstruct_field(prism_patterns)
```

look at the mean and standard deviation of the unexplained variance. We're only focusing on "snowy pixels" where the median is > 3mm
```{r}
resids <- prism_recon %>%
   left_join(prism_dat, by = c('x', 'y', 'year'), suffix = c('_recon', '_obs')) %>%
    mutate(error = SWE_recon - SWE_obs) %>%
  group_by(x, y) %>%
 # filter(median(SWE_recon) > 3 & median(SWE_obs) > 3) %>%
  ungroup()

resids %>%
  group_by(x, y) %>%
  summarise(avg = mean(error),
            stdev = sd(error)) %>%
    ggplot() +
  geom_raster(aes(x, y, fill = avg)) +
  geom_sf(data = states_wus, fill = NA, color = 'black') +
  theme_void() +
  scale_fill_viridis_c() +
  ggtitle('Error from dimensionality reduction', 'PRISM')
```

```{r}
prism_recon %>%
   get_errors %>%
  group_by(x, y) %>%
   # filter(median(SWE_recon) > 3 & median(SWE_obs) > 3) %>%
  summarise(avg = mean(accuracy_ratio)) %>%
    ggplot() +
  geom_raster(aes(x, y, fill = avg)) +
  geom_sf(data = states_wus, fill = NA, color = 'black') +
  theme_void() +
  scale_fill_viridis_c() +
  ggtitle('Error from dimensionality reduction', 'PRISM')
```

Differences in snowy pixels. in general, by truncating at 4, we slightly overestimate the amount of snowy pixels.
```{r}
prism_recon %>%
   left_join(prism_dat, by = c('x', 'y', 'year'), suffix = c('_recon', '_obs'))%>%
  group_by(x, y) %>%
  summarise(rec_med = median(SWE_recon),
            obs_med = median(SWE_obs)) %>%
  mutate(obs_snowy = obs_med > 3,
         rec_snowy = rec_med > 3,
         agreed = case_when(obs_snowy == rec_snowy & obs_snowy == TRUE ~'True positive',
                            obs_snowy == rec_snowy & obs_snowy == FALSE ~'True negative',
                            obs_snowy != rec_snowy & obs_snowy == TRUE ~'False negative',
                            obs_snowy != rec_snowy & obs_snowy == FALSE ~ 'False positive')) %>%
      ggplot() +
  geom_raster(aes(x, y, fill = agreed)) +
  geom_sf(data = states_wus, fill = NA, color = 'black') +
  theme_void() +
  scale_fill_viridis_d()
```


Look here, the observations have some extremely (suspect?) high values -- noise that the pca removes? or real?
```{r}
resids %>%
  ggplot(aes(SWE_obs, SWE_recon)) +
  geom_point(alpha = .1) +
  geom_smooth() +
  theme_bw()

resids %>%
  ggplot(aes(error)) +
  geom_histogram() +
  theme_bw()

resids %>% group_by(x, y) %>%
  filter(median(SWE_recon) > 3 & median(SWE_obs) > 3) %>%
  ggplot(aes(error)) +
  geom_histogram() +
  theme_bw()
```

```{r}
resids %>%
  arrange(error)
```


Is it normal?


```{r}
resids %>%
  group_by(x, y) %>%
  summarise(p = shapiro.test(error)$p) %>%
  ggplot() +
    geom_raster(aes(x, y, fill = p < 0.05)) +
  geom_sf(data = states_wus, fill = NA, color = 'black') +
  theme_void() +
  scale_fill_viridis_d() +
  ggtitle('Error from dimensionality reduction', 'PRISM')
```


```{r}
score_map <- prism_recon %>%
  get_errors() %>%
  group_by(x, y) %>%
  get_scores()

score_ts <- prism_recon %>%
  get_errors() %>%
    group_by(x, y) %>%
    filter(median(SWE_recon) > 3 & median(SWE_obs) > 3) %>%
  ungroup() %>%
  group_by(year) %>%
  get_scores()
```


```{r, fig.width = 10}
score_ts %>%
  gather(metric, value, me:rmsle) %>%
  ggplot(aes(year, value)) +
  geom_line() +
  facet_wrap(~metric, scales = 'free_y') +
  theme_bw()
```


```{r}
  plot_fun <- function(x, name) {
      ggplot(x) +
  geom_raster(aes(x, y, fill = value)) +
  geom_sf(data = states_wus, fill = NA, color = 'black') +
  theme_void() +
  scale_fill_viridis_c(name = name)
  }

tmp <- score_map %>%
gather(metric, value, me:rmsle) %>%
group_by(metric) %>%
  nest %>%
  mutate(plots = map2(data, metric, plot_fun))
tmp$plots
```

```{r}
score_map %>%
      ggplot() +
  geom_raster(aes(x, y, fill = srmse < .7)) +
  geom_sf(data = states_wus, fill = NA, color = 'black') +
  theme_void() +
  scale_fill_viridis_d()
```


## Trends

Are there any trends?

```{r}
trends_mod <- prism_patterns$amplitudes %>%
  mutate(PC = paste0('PC', PC)) %>% 
  group_by(PC) %>%
  nest() %>%
  mutate(mod = map(data, ~gam(amplitude ~ 
                                s(year, k = 4), 
                              data = ., 
                              method = 'REML', 
                              select = TRUE))) %>%
  mutate(r2 = map_dbl(mod, ~summary(.)$r.sq)) %>%
  mutate(data = map2(data, mod, add_predictions),
         data = map2(data, mod, add_residuals)) 

walk(trends_mod$mod, plot)
```

```{r}

test <- prism_dat %>%
  group_by(x, y) %>%
  nest() %>%
  mutate(mod = map(data, ~lm(SWE ~ year, data = .) %>% broom::tidy())) %>%
  select(-data) %>%
  unnest %>%
  filter(term == 'year')


test %>%
   ggplot() +
    geom_raster(aes(x, y, fill = estimate)) +
  geom_sf(data = states_wus, fill = NA, color = 'black') +
  theme_void() +
  scale_fill_distiller(palette = 'RdBu')


test %>%
   ggplot() +
    geom_raster(aes(x, y, fill = p.value < .05)) +
  geom_sf(data = states_wus, fill = NA, color = 'black') +
  theme_void() 
```


# Coupled Pattern Analysis

First look at just the error from the dimensionality reduction  with the PCs. This is basically the error in the pc targets, so is the minimum error we'd get even from the best downscaling

## GLM

```{r}
library(glmnet)
library(MuMIn)

gam_formula <-  prep_data(cera_patterns, prism_patterns)  %>%
    # this should be more flexible below, checking for innapropriate predictors
    dplyr::select(-PC, -amplitude, -year) %>%
    names() %>%
    map( ~ paste0("s(", ., ", bs = 'cr', k = 4)")) %>%
    paste(collapse = ' + ') %>%
    paste('amplitude ~ ', .) %>%
    as.formula

glm_formula <- prep_data(cera_patterns, prism_patterns)  %>%
    # this should be more flexible below, checking for innapropriate predictors
    dplyr::select(-PC, -amplitude, -year) %>%
    names() %>%
    paste(collapse = ' + ') %>%
    paste('amplitude ~ ', .) %>%
    as.formula

# prep data, nest by target pc
test <- prep_data(cera_patterns, prism_patterns) %>%
   group_by(PC) %>%
    nest()# %>%
testdat <- test[[1,2]][[1]]

glm(glm_formula, data = testdat)

t1 <- lm(glm_formula, data = testdat, na.action = "na.fail")
t2 <- dredge(t1)
summary(get.models(t2, 1)[[1]])
t2

test_gam <- gam(gam_formula, method = 'REML',select = TRUE, data = testdat, na.action = "na.fail")
test_gam2 <- gam(gam_formula, data = testdat, na.action = "na.fail")
t3 <- dredge(test_gam2)
t3
summary(get.models(t3, 1)[[1]])

plot(test_gam)

t4 <- glmnet(testdat %>%
  select(PC1:PC9) %>% 
  as.matrix(), pull(testdat, amplitude), standardize = FALSE)
plot(t4)
coef(t4, s = .1);coef(t4, s = .05)


# this isnt!
t6 <- cv.glmnet(testdat %>%
  select(PC1:PC9) %>% 
  as.matrix(), pull(testdat, amplitude), standardize = FALSE, nfolds = 5, foldid = rep(1:5, each = 6, length.out =29))
plot(t6)
coef(t6, s = "lambda.1se")
coef(t6, s = "lambda.min")

t7<- prep_data(cera_patterns, prism_patterns) %>%
   group_by(PC) %>%
    nest() %>%
mutate(mod1 = map(data, ~ gam(gam_formula, data = ., method = 'REML',select = TRUE)),
       mod2 = map(data, ~ eval(getCall(dredge(gam(gam_formula, data = ., na.action = "na.fail")), 1))),
       mod3 = map(data, ~ eval(getCall(dredge(lm(glm_formula, data = ., na.action = "na.fail")), 1)))) %>%
    ungroup() %>%
    mutate(r21 = map_dbl(mod1, ~ sqrt(mean(.$residuals^2))),
           r22 = map_dbl(mod2, ~ sqrt(mean(.$residuals^2))),
           r23 = map_dbl(mod3, ~ sqrt(mean(.$residuals^2)))) 

sqrt(mean(res$residuals^2))

t7$mod1[[1]] %>% plot
t7$mod2[[1]] %>% plot



prep_data(cera_patterns, prism_patterns) %>%
   group_by(PC) %>%
    nest() %>%
mutate(mod = map(data, ~ eval(getCall(dredge(lm(glm_formula, data = ., na.action = "na.fail")), 1))),
       preds = map2(mod, data, predict)) %>%
         select(-mod) %>%
    unnest(cols = c(data, preds)) %>%
  select(PC, year, amplitude, preds)
```


```{r}
fit_pcr <- function(data_in) {
  lm_formula <- data_in %>%
    # this should be more flexible below, checking for inapropriate predictors
    dplyr::select(-PC, -amplitude, -year) %>%
    names() %>%
    paste(collapse = ' + ') %>%
    paste('amplitude ~ ', .) %>%
    as.formula
  
  data_in %>%
    group_by(PC) %>%
    nest() %>%
    mutate(mod = map(data, ~ eval(getCall(dredge(lm(lm_formula, data = ., na.action = "na.fail")), 1)))) %>%
    ungroup()
}
```


## GAM

Let's look under the hood of what the GAM models above were doing.
```{r}
gam_mod <- couple_patterns(cera_patterns, prism_patterns)
```

```{r}
walk(gam_mod$model$mod, plot)
```

How do the models perform?
```{r}
gam_mod$model %>%
  select(PC, r2) %>%
  arrange(-r2)
```

Are the residuals autocorrelated? Some are
```{r}
gam_mod$data %>%
  group_by(PC) %>%
  summarise(autocor = cor(resid, lag(resid), use = 'pairwise.complete.obs')) %>%
  arrange(-abs(autocor))
```

```{r}
ggplot(gam_mod$data, aes(resid)) +
  #geom_histogram() + 
  geom_density(fill = NA) +
  geom_vline(xintercept = 0, color = 'red', linetype = 2) +
  facet_wrap(~PC) +
  theme_bw()
```

```{r}
gam_recon <- predict_patterns(gam_mod, cera_patterns) %>%
  reconstruct_field(prism_patterns, .)

gam_score_map <- gam_recon %>%
  get_errors() %>%
  group_by(x, y) %>%
  get_scores()
```


```{r}
gam_score_map %>%
 # group_by(x, y) %>%
#  summarise(corr = cor(SWE_recon, SWE_obs)) %>%
   ggplot() +
      geom_raster(aes(x, y, fill = corr)) +
      geom_sf(data = states_wus, fill = NA, color = 'black') +
      scale_fill_viridis_c() +
      theme_void()
```

```{r}
ggplot(gam_score_map ) +
      geom_raster(aes(x, y, fill = srmse < .7)) +
      geom_sf(data = states_wus, fill = NA, color = 'black') +
      scale_fill_viridis_d() +
      theme_void()
```

```{r}
ggplot(gam_score_map ) +
      geom_raster(aes(x, y, fill = srmse)) +
      geom_sf(data = states_wus, fill = NA, color = 'black') +
      scale_fill_viridis_c() +
      theme_void()
```


```{r}
e <- prism_dat %>%
      filter(between(year, 1990, 2010)) %>%
  group_by(x, y) %>%
  ggplot() +
  geom_raster(aes(x, y, fill = SWE)) +
  geom_sf(data = states_wus, fill = NA, color = 'black') +
  scale_fill_scico(palette = 'davos', direction = -1, name = 'SWE (mm)') +
    transition_states(year) +
    ggtitle("March {closest_state} SWE", "Observed") +
  theme_void() +
  theme(legend.position = 'bottom')

f <- gam_recon %>%
      filter(between(year, 1990, 2010)) %>%
  group_by(x, y) %>%
  mutate(anomaly = (SWE - mean(SWE)) / sd(SWE))  %>% 
  ggplot() +
  geom_raster(aes(x, y, fill = SWE)) +
  geom_sf(data = states_wus, fill = NA, color = 'black') +
  scale_fill_scico(palette = 'davos', direction = -1, name = 'SWE (mm)') +
    transition_states(year) +
    ggtitle("", "Reconstructed") +
  theme_void() +
  theme(legend.position = 'bottom')


e_gif <- gganimate::animate(e)
f_gif <- gganimate::animate(f)

e_mgif <- image_read(e_gif)
f_mgif <- image_read(f_gif)

new_gif <- image_append(c(e_mgif[1], f_mgif[1]))
for(i in 2:100){
  combined <- image_append(c(e_mgif[i], f_mgif[i]))
  new_gif <- c(new_gif, combined)
}

new_gif

image_write(new_gif, 'reconstruction.gif')
```


```{r}
knitr::knit_exit()
```

## CCA

```{r}
obs_amps_cca <- prism_dat %>%
  filter(year <= 2010) %>%
  get_patterns(k = 4) %>%
  .$amplitudes %>%
  mutate(PC = as.numeric(PC)) %>% # so spread doesn't lose order of columns
  spread(PC, amplitude) %>%
  select(-year) %>%
  as.matrix()

preds_amps_cca <- cera_dat %>%
  filter(year >=1982) %>%
  get_patterns(k = 5) %>%
  .$amplitudes %>%
  mutate(PC = as.numeric(PC)) %>%
  spread(PC, amplitude) %>%
  select(-year) %>%
  as.matrix()

  # train CCA on training data
  cca <- cancor(preds_amps_cca, obs_amps_cca, xcenter = FALSE, ycenter = FALSE)
  
  prism_can <- prism_dat %>%
    filter(year <= 2010) %>%
  get_patterns(k = 4) %>%
    .$eofs %>%
  select(-value) %>%  # use normalized or unnormalized?
    mutate(EOF = str_pad(EOF, 2, 'left', '0')) %>%
  spread(EOF, weight) %>%
  select(-x, -y) %>%
  as.matrix() %>%
  `%*%`(cca$ycoef[,1:4]) %>%
    `colnames<-`(paste0('PC', 1:4)) %>%
  as_tibble()
  
cera_can <- cera_dat %>%
        filter(year >= 1982) %>%
get_patterns(k = 5) %>%
    .$eofs %>%
  select(-value) %>%
  spread(EOF, weight) %>%
  select(-x, -y) %>%
  as.matrix() %>%
  `%*%`(cca$xcoef[,1:4]) %>%
  `colnames<-`(paste0('PC', 1:4)) %>%
  as_tibble()
```

```{r fig.width = 8, fig.asp = .7}

a <- preds_amps_cca %*%
    cca$xcoef[,1:4, drop = FALSE] %>%
  `colnames<-`(paste0('EOF', 1:4)) %>%
  as_tibble %>%
  mutate(year = 1982:2010) %>%
  gather(eof, amplitude, EOF1:EOF4) %>%
  full_join(filter(cera_dat, year >= 1982), by = 'year') %>%
  group_by(x, y, eof) %>%
  summarise(correlation = -1 * cor(amplitude, SWE)) %>%
   ggplot() +
      geom_raster(aes(x, y, fill = correlation)) +
      geom_sf(data = states_wus, fill = NA, color = 'black') +
      facet_wrap(~eof, nrow = 1) +
      scale_fill_scico(palette = 'vik', direction = -1, limits = c(-1, 1)) +
      theme_void()

b <- obs_amps_cca %*%
    cca$ycoef[,1:4, drop = FALSE] %>%
    `colnames<-`(paste0('EOF', 1:4)) %>%
  as_tibble %>%
  mutate(year = 1982:2010) %>%
  gather(eof, amplitude, EOF1:EOF4) %>%
  full_join(filter(prism_dat, year <= 2010), by = 'year') %>%
  group_by(x, y, eof) %>%
  summarise(correlation = -1 * cor(amplitude, SWE)) %>%
   ggplot() +
      geom_raster(aes(x, y, fill = correlation)) +
      geom_sf(data = states_wus, fill = NA, color = 'black') +
      facet_wrap(~eof, nrow = 1) +
      scale_fill_scico(palette = 'vik', direction = -1, limits = c(-1, 1)) +
      theme_void()

c <- b / a & theme(legend.position = "bottom")
c + plot_layout(guides = "collect", heights = 1) + plot_annotation(tag_levels = 'A')

ggsave('cca_patterns.png', width = 8, height = 5.6)
```

```{r, fig.width = 8, fig.asp=.7}
  d<- cera_dat %>%
  spread(year, SWE) %>%
  mutate(column = 1:n()) %>%
  select(x, y, column) %>%
  bind_cols(cera_can) %>%
  gather(pattern, value, starts_with('PC')) %>%
  ggplot() +
  geom_raster(aes(x, y, fill = value)) +
  geom_sf(data = states_wus, fill = NA, color = 'black') +
  facet_wrap(~pattern, nrow = 1) +
      scale_fill_scico(palette = 'vik', direction = -1, limits = c(-1, 1) * 6) +
  theme_void()+
  coord_sf()

e <- prism_dat %>%
  spread(year, SWE) %>%
  mutate(column = 1:n()) %>%
  select(x, y, column) %>%
  bind_cols(prism_can) %>%
  gather(pattern, value, starts_with('PC')) %>%
  ggplot() +
  geom_raster(aes(x, y, fill = value)) +
  geom_sf(data = states_wus, fill = NA, color = 'black') +
  facet_wrap(~pattern, nrow = 1) +
      scale_fill_scico(palette = 'vik', direction = -1, limits = c(-1, 1) * 70) +
  theme_void()+
  coord_sf()

d / e + plot_layout(heights = 1) + plot_annotation(tag_levels = 'A')
```


## EOT

```{r}
cera_rast <- cera_dat %>%
  filter(year >= 1982) %>%
  spread(year, SWE) %>%
  rasterFromXYZ() 

prism_rast <- prism_dat %>%
  filter(year <= 2010) %>%
  spread(year, SWE) %>%
  rasterFromXYZ(res = c(0.08333333, 0.08333334), crs = '+proj=longlat +pm=0 +a=6378137 +rf=298.257222101')

eot1 <- cera_rast %>%
  anomalize() %>%
  denoise(k = 10, weighted = TRUE)

eot2 <- prism_rast %>%
  anomalize() %>% 
  denoise(k = 10, weighted = TRUE)
```
ok so the new raster doesn't have all the no snow areas. and its cropped to the state boundaries. so just stay in raster land until the end? area weight 
```{r}
telecon <- eot(eot1, eot2, n = 10, standardised = FALSE)
```

```{r}
walk(1:10, ~plot(telecon, y = ., show.bp = TRUE))
```

```{r}
m1 <- purrr::map_dbl(1:10, ~((predict(telecon, eot1, n = .) + mean(prism_rast)) * area(prism_rast))%>% cellStats(sum) %>%
  `-`(cellStats(prism_rast * area(prism_rast), sum)) %>%
  `^`(2) %>%
  mean %>%
  sqrt)

plot(m1)
```





## Delta

```{r}
delta <- function(pred, obs, newdata) {
  
  pred_clim <- get_climatology(pred)
  obs_clim <- get_climatology(obs)
  
  newdata %>% # change back to newdata
    left_join(pred_clim, by = c('x', 'y')) %>% # should check that this join works
  mutate(anomaly = SWE / swe_mean) %>%
    select(x,y, year, anomaly) %>%
    group_by(year) %>%
    nest() %>%
    mutate(anomaly = map(data, ~ metR::Interpolate(anomaly ~ x + y, x.out = obs_clim$x, y.out = obs_clim$y, grid = FALSE, data = .)$anomaly)) %>%#gam(anomaly ~ s(x, y, k = 300, bs = 'gp'), data = .))) %>%
    select(-data) %>%
   mutate(data = rep(list(obs_clim), n())) %>%
  #  mutate(anomaly = map2(mod, data, predict, type = 'response')) %>%
 #   select(-mod) %>%
    unnest(c(data, anomaly)) %>% 
    ungroup() %>%
    mutate(SWE = swe_mean * if_else(anomaly >=0, anomaly, 0)) %>%
    select(year, x, y, SWE)
}

prep_kfold_delta <- function(preds, obs, type = NULL){
    # find the years of overlap between the response and predictor fields
  years <- intersect(preds$year, obs$year)
  preds <- filter(preds, year %in% years)
  obs <- filter(obs, year %in% years)

  # divide years into 5 contiguous folds
  n <- length(years)
  r <- n %% 5
  fold_times <- rep(n %/% 5, 5)
  fold_times[1:r] <- fold_times[1:r] + 1

  folds <- tibble(year = years, fold = rep(1:5, times = fold_times))

  train_obs <- map(1:5, ~ filter(folds, fold == .) %>%
                     anti_join(obs, ., by = 'year'))

  train_preds <- map(1:5, ~ filter(folds, fold == .) %>%
                      anti_join(preds, ., by = 'year'))

  # preprocess test data for each fold
  test <- map(1:5, ~ filter(folds, fold == .) %>%
                semi_join(preds, ., by = 'year')) # test years

  tibble(train_obs, train_preds, test)
}
# this is just prep_cca without the patterns ... redundant?
```

```{r}
t2 <- prep_kfold_delta(cera_dat, prism_dat) # prep_cca would work here too

clim_baseline <- t2 %>%
  mutate(clim = map(train_obs, get_climatology),
         year = map(test, ~pull(., year) %>% unique)) %>%
  select(clim, year) %>%
  unnest(year) %>%
  unnest(clim) %>%
  rename(SWE = swe_mean) %>%
  get_errors  %>% 
   left_join(areas, by = c("x", "y")) %>%
    group_by(year) %>%
    summarise(SWE_obs = sum(SWE_obs * area),
              SWE_recon = sum(SWE_recon * area)) %>%
    mutate(error = SWE_recon - SWE_obs) %>% pull(error) %>% `^`(2) %>% mean %>% sqrt
```


```{r}
t3 <- pmap_dfr(list(t2$train_preds, t2$train_obs, t2$test), delta) %>% 
  arrange(x, y, year) %>%
    get_errors()

  c(rmse = summarise(t3, rmse = sqrt(mean(error^2, na.rm = TRUE))) %>% pull(rmse),
    corr = total_swe_corr(t3))
```

```{r}

t1 <- delta(filter(cera_dat, year >= 1982), filter(prism_dat, year <= 2010), filter(cera_dat, year == 1991))


 ggplot(t1) +
  geom_raster(aes(x, y, fill = SWE)) +
  geom_sf(data = states_wus, fill = NA, color = 'black') +
  scale_fill_viridis_c(limits = c(0, 3500)) +
  theme_void() +
  theme(legend.position = 'bottom')
 
  ggplot(prism_dat %>% filter(year == 1991)) +
  geom_raster(aes(x, y, fill = SWE)) +
  geom_sf(data = states_wus, fill = NA, color = 'black') +
  scale_fill_viridis_c(limits = c(0, 3500)) +
  theme_void() +
  theme(legend.position = 'bottom')
  
  
  predict_cca(cera_dat %>% filter(year >= 1982)%>% get_patterns(k = 4), prism_dat %>% filter(year <= 2010) %>% get_patterns(k = 4), cera_dat %>% filter(year == 1991), k = 4) %>% 
     ggplot() +
  geom_raster(aes(x, y, fill = SWE)) +
  geom_sf(data = states_wus, fill = NA, color = 'black') +
  scale_fill_viridis_c(limits = c(0, 3500)) +
  theme_void() +
  theme(legend.position = 'bottom')
```




# Cross-validation

Set up a 5 fold cross validation experiment for selecting the truncation level, $k$, for each set of PCs.


```{r}
cv_eot_data <- prep_eot(cera_dat, prism_dat, 10, 10, 10)
```

```{r}
cv_eot <- tibble(k = 1:10) %>%
  mutate(pred = purrr::map(k, predict_eot, cv = cv_eot_data),
         error = purrr::map(pred, cv_eot_error)) %>%
  select(k, error) %>%
  unnest_wider(error)
```

```{r}
write_csv(cv_eot, 'cv_eot.csv')
```


```{r}
cv_cca <- expand_grid(kx = 1:10, ky = 1:10, kxy = 1:10) %>%
  filter(kxy <= pmin(kx, ky)) %>%
  mutate(cv = pmap(list(kx, ky, kxy), ~prep_cca(..1, ..2, preds = cera_dat, obs = prism_dat) %>% fit_cv(fun = predict_cca, k = ..3))) %>%
  unnest_wider(cv)
```

```{r}
library(MuMIn)
# does this work for gams too?
cv_pcr <- expand_grid(kx = 1:10, ky = 1:10) %>%
  mutate(cv = map2(kx, ky, ~prep_cca(.x, .y, preds = cera_dat, obs = prism_dat) %>% fit_cv(fun = predict_pcr, k = .y))) %>%
  unnest_wider(cv)
```

```{r}
# does this work for gams too?
cv_gam <- expand_grid(kx = 1:10, ky = 1:10) %>%
  mutate(cv = map2(kx, ky, ~prep_cca(.x, .y, preds = cera_dat, obs = prism_dat) %>% fit_cv(fun = predict_gam, k = .y))) %>%
  unnest_wider(cv)
```

```{r}
cv_gam %>%
  arrange(rmse)
cv_gam %>% arrange(-corr)
```

```{r}
cv_pcr %>%
  arrange(rmse)
cv_pcr %>% arrange(-corr)
```

```{r}
write_csv(cv_pcr, 'cv_pcr.csv');write_csv(cv_gam, 'cv_gam.csv')
```

```{r}
write_csv(cv_cca, 'cv_cca.csv')
```

```{r}
cv_cca <- read_csv('cv_cca.csv')
cv_eot <- read_csv('cv_eot.csv')
```



```{r}
cv_cca %>% arrange(rmse)
cv_cca %>% arrange(-corr)

cv_eot %>% arrange(rmse)
cv_eot %>% arrange(-corr)
```

```{r}
cv_cca%>%
  ggplot(aes(rmse, corr)) +  geom_point(aes(color = as.factor(kx)), size = 3, alpha = .5) + theme_bw() +
  scale_color_viridis_d() + 
  scale_x_continuous(breaks = 1:10, minor_breaks = NULL)# + geom_hline(yintercept = clim_baseline)

cv_eot %>%
  ggplot(aes(rmse, corr)) +  geom_point(aes(color = as.factor(k)), size = 3, alpha = .5) + theme_bw() +
  scale_color_viridis_d() + 
  scale_x_continuous(breaks = 1:10, minor_breaks = NULL)# + geom_hline(yintercept = clim_baseline)
```

```{r}
cv_cca  %>%
  ggplot(aes(kxy, rmse)) +  geom_point(aes(color = as.factor(kx)), size = 2, alpha = .5) + theme_bw() +
  scale_color_viridis_d() + 
  geom_line(data = filter(group_by(cv_cca, kxy), rmse == min(rmse))) +
  scale_x_continuous(breaks = 1:10, minor_breaks = NULL)# + geom_hline(yintercept = clim_baseline)
```


```{r}
cv_cca%>%
  ggplot(aes(kxy, corr)) +  geom_point(aes(color = as.factor(kx)), size = 2, alpha = .5) + 
  theme_bw() +
  scale_color_viridis_d() + 
  geom_line(data = filter(group_by(cv_cca, kxy), corr == max(corr))) +
  scale_x_continuous(breaks = 1:10, minor_breaks = NULL) #+ geom_hline(yintercept = clim_baseline)
```


```{r}
cv_cca %>%
  group_by(kxy) %>%
  filter(rmse == min(rmse)) %>%
  ungroup()%>%
  arrange(kxy) %>%
  mutate(test = (rmse <= lead(rmse)))

cv_cca %>%
  group_by(kxy) %>%
  filter(rmse == min(rmse)) %>%
  ggplot(aes(kxy, rmse)) +
  geom_line()

cv_eot %>%
  arrange(k) %>%
  mutate(test = (rmse <= lead(rmse)))
```

```{r, fig.asp = .4}
a <- cv_cca %>%
  group_by(kxy) %>%
  filter(rmse == min(rmse)) %>%
  rename(k = kxy) %>%
  bind_rows(cv_eot, .id = 'Method') %>%
  mutate(Method = if_else(Method == '1', 'CCA', 'EOT')) %>%
  ggplot(aes(k, rmse)) +
  geom_line(aes(group = Method, color = Method), size = 1.2) +
scale_color_grey() +
  theme_bw() +
    scale_x_continuous(breaks = 1:10, minor_breaks = NULL) +
    labs(x = 'Coupled patterns', y = 'RMSE (Ml)')+geom_line(data = cv_eot20) #+ geom_hline(yintercept = clim_baseline)

b <- cv_cca %>%
  group_by(kxy) %>%
  filter(corr == max(corr)) %>%
  rename(k = kxy) %>%
  bind_rows(cv_eot, .id = 'Method') %>%
    mutate(Method = if_else(Method == '1', 'CCA', 'EOT')) %>%
  ggplot(aes(k, corr)) +
  geom_line(aes(group = Method, color = Method), size = 1.2) +
scale_color_grey() +
  theme_bw() +
    scale_x_continuous(breaks = 1:10, minor_breaks = NULL) + 
  labs(x = 'Coupled patterns', y = 'Domain-wide correlation')+geom_line(data = cv_eot20) #+ geom_hline(yintercept = clim_baseline)

a + b +plot_layout(guides = 'collect') + plot_annotation(tag_levels = 'A')

ggsave('method_comparison.png', height = 2.4, width = 6)
```


```{r}
cv_cca %>%
  group_by(kxy) %>%
  filter(corr == max(corr)) %>%
  ungroup()%>%
  arrange(kxy) %>%
  mutate(test = corr >= lead(corr))

cv_eot %>%
  arrange(k) %>%
  mutate(test = corr >= lead(corr))
```




```{r, fig.width=10, fig.asp = 1}
predict_cca(get_patterns(filter(cera_dat, year >= 1982), 5), 
            get_patterns(filter(prism_dat, year <= 2010), 4), 
            filter(cera_dat, year >= 1982),
            k = 4) %>%
  group_by(x,y) %>%
  mutate(anomaly = SWE - mean(SWE)) %>%
  ggplot(aes(x,y, fill = anomaly)) +
  geom_raster() +
  facet_wrap(~year) +
  scale_fill_scico(palette = 'vik', limits = c(-1000, 1000)) +
  coord_quickmap() +
  theme_void()

predict_cca(get_patterns(filter(cera_dat, year >=1982), 10), 
            get_patterns(filter(prism_dat, year <=2010), 9), 
            filter(cera_dat, year >= 1982),
            k = 7) %>%
  group_by(x,y) %>%
  mutate(anomaly = SWE - mean(SWE)) %>%
  ggplot(aes(x,y, fill = anomaly)) +
  geom_raster() +
  facet_wrap(~year) +
  scale_fill_scico(palette = 'vik', limits = c(-1000, 1000)) +
  coord_quickmap() +
  theme_void()
```

```{r, fig.width=8}
a <- cv_cca %>%
  group_by(kxy, kx) %>%
  summarise(rmse = min(rmse)) %>%
    ggplot(aes(kx, kxy)) +
  geom_tile(aes(fill = rmse)) +
  scale_fill_viridis_c(direction = -1, limits = c(41.7, 54.7)) +
  theme_minimal() +
  scale_x_continuous(breaks = 1:10, minor_breaks = NULL) +
  scale_y_continuous(breaks = 1:10, minor_breaks = NULL) +
  coord_fixed()

b <- cv_cca %>%
  group_by(kxy, ky) %>%
  summarise(rmse = min(rmse)) %>% 
    ggplot(aes(ky, kxy)) +
  geom_tile(aes(fill = rmse)) +
  scale_fill_viridis_c(direction = -1, limits = c(41.7, 54.7)) +
  theme_minimal() +
  scale_x_continuous(breaks = 1:10, minor_breaks = NULL) +
  scale_y_continuous(breaks = 1:10, minor_breaks = NULL) +
  coord_fixed()

c <- cv_cca %>%
  group_by(kx, ky) %>%
  summarise(rmse = min(rmse)) %>%
    ggplot(aes(kx, ky)) +
  geom_tile(aes(fill = rmse)) +
  scale_fill_viridis_c(direction = -1, limits = c(41.7, 54.7)) +
  theme_minimal() +
  scale_x_continuous(breaks = 1:10, minor_breaks = NULL) +
  scale_y_continuous(breaks = 1:10, minor_breaks = NULL) +
  coord_fixed()

d <- cv_cca %>%
  group_by(kxy, kx) %>%
  summarise(corr = max(corr)) %>%
    ggplot(aes(kx, kxy)) +
  geom_tile(aes(fill = corr)) +
  scale_fill_viridis_c(option = 'magma', direction = 1, limits = c(0.764, 0.935)) +
  theme_minimal() +
  scale_x_continuous(breaks = 1:10, minor_breaks = NULL) +
  scale_y_continuous(breaks = 1:10, minor_breaks = NULL) +
  coord_fixed()

e <- cv_cca %>%
  group_by(kxy, ky) %>%
  summarise(corr = max(corr)) %>%
    ggplot(aes(ky, kxy)) +
  geom_tile(aes(fill = corr)) +
  scale_fill_viridis_c(option = 'magma', direction = 1, limits = c(0.764, 0.935)) +
  theme_minimal() +
  scale_x_continuous(breaks = 1:10, minor_breaks = NULL) +
  scale_y_continuous(breaks = 1:10, minor_breaks = NULL) +
  coord_fixed()

f <- cv_cca %>%
  group_by(kx, ky) %>%
  summarise(corr = max(corr)) %>%
    ggplot(aes(kx, ky)) +
  geom_tile(aes(fill = corr)) +
  scale_fill_viridis_c(option = 'magma', direction = 1, limits = c(0.764, 0.935)) +
  theme_minimal() +
  scale_x_continuous(breaks = 1:10, minor_breaks = NULL) +
  scale_y_continuous(breaks = 1:10, minor_breaks = NULL) +
  coord_fixed()

(a+b +c + plot_layout(guides = 'collect')) / (d + e + f + plot_layout(guides = 'collect')) + plot_annotation(tag_levels = 'A')

ggsave('cca_cv.png', width = 8, height = 4.944)
```

```{r, fig.width = 10, fig.asp = 1}
cv_cca %>%
  ggplot(aes(kxy, rmse)) +
  geom_point() +
  facet_grid(kx~ky) +
  scale_fill_viridis_c(direction = -1) +
  theme_bw() +
  geom_hline(yintercept = 25468076, color = 'red', linetype = 2)
```

```{r}
cca_test %>%
  filter(kxy == pmin(kx, ky)) %>%
  ggplot(aes(kxy, rmse, color = kx+ ky, group = (kx + ky))) + geom_line(alpha = .4) + geom_point() + theme_bw() + geom_hline(yintercept = clim_baseline)
```

```{r}
cca_errors %>% group_by(k) %>%
  summarise(rmse = sqrt(mean(error^2))) %>%
  #filter(rmse <= min(rmse) + sd(rmse)) %>% arrange(k)
  ggplot(aes(k, rmse)) + geom_line() +geom_point() + theme_bw() + geom_hline(yintercept = clim_baseline)+ geom_hline(yintercept = 20944883)
  
left_join(eot_errors, cca_errors, by = c('k', 'year')) %>%
  # ggplot(aes(year, group = k, color = k)) +
  # geom_line(aes(y = SWE_recon.x)) +
  # geom_line(aes(y = SWE_recon.y)) +
  # geom_line(aes(y = SWE_obs.x), color = 'red')
#####
select(k, year, error.x, error.y) %>%
  rename(eot = error.x, cca = error.y) %>%
  gather(type, error, eot:cca) %>%
  group_by(type, k) %>%
  summarise(rmse = sqrt(mean(error^2))) %>%
  #filter(rmse <= min(rmse) + sd(rmse)) %>% arrange(k)
  ggplot(aes(k, rmse, color = type)) + geom_line() +geom_point() + theme_bw() + geom_hline(yintercept = clim_baseline) +
  geom_point(data = tibble(k = 1:10, rmse = m1, type = 'eot'))
```
8123883,2491917

```{r}
cv_dat2 <- expand_grid(k_predictor = 1:9, k_response = 1:9) %>%
  mutate(kfolds = map2(k_predictor, k_response, ~prep_kfold(.x, .y, preds = cera_dat, obs = prism_dat)),
         gam = map(kfolds, fit_cv, fun = predict_gam),
         cca = map(kfolds, fit_cv, fun = predict_cca)) %>%
  select(-kfolds) %>%
  gather(type, metric, gam:cca) 

saveRDS(cv_dat, 'cv_dat')
```

```{r}
cv_dat2%>%
  gather(type, metric, gam:cca) %>%
  unnest(metric) %>%
  ggplot(aes(year, group = interaction(k_predictor, k_response, type)))+
    geom_line(aes(y = SWE_obs), color = 'red') +
  geom_line(aes(y = SWE_recon, color = type), alpha = .1) 
```

```{r}
cv_dat2 %>%
  gather(type, metric, gam:cca)%>%
  mutate(rmse = map_dbl(metric, ~sqrt(mean((.$SWE_recon - .$SWE_obs)^2)))) %>%
  select(-metric) %>%
  arrange(rmse)  %>%
  filter(rmse <= (min(rmse) + sd(rmse))) %>%
      mutate(test = k_predictor + k_response) %>%
  arrange(test)
```

```{r}
t4 %>%
  summarise(rmse = sqrt(mean((SWE_recon - SWE_obs)^2)))
```


```{r}
cv_dat2 %>%
  gather(type, metric, gam:cca)%>%
  mutate(rmse = map_dbl(metric, ~sqrt(mean((.$SWE_recon - .$SWE_obs)^2)))) %>%
  select(-metric) %>%
      ggplot(aes(k_predictor, k_response, fill = rmse)) +
  geom_tile() +
  scale_fill_viridis_c(direction = -1) +
  facet_wrap(~type) +
  scale_x_continuous(breaks = 1:9, minor_breaks = NULL) +
  scale_y_continuous(breaks = 1:9, minor_breaks = NULL) +
  coord_equal() +
  theme_minimal()
```



```{r}
loadRDS('cv_dat')
cv_dat %>%
  gather(type, metric, gam:cca) %>%
  mutate(rmse = map_dbl(metric, ~mean(.$rmse))) %>%
  select(-metric) %>%
  arrange(rmse) %>%
  filter(rmse < (min(rmse) + sd(rmse))) %>%
      mutate(test = k_predictor + k_response) %>%
  arrange(test)

cv_dat %>%
  gather(type, metric, gam:cca) %>%
  mutate(rmse = map_dbl(metric, ~mean(.$rmse))) %>%
  select(-metric) %>%
    ggplot(aes(k_predictor, k_response, fill = rmse)) +
  geom_tile() +
  scale_fill_viridis_c(direction = -1) +
  facet_wrap(~type) +
  scale_x_continuous(breaks = 1:9, minor_breaks = NULL) +
  scale_y_continuous(breaks = 1:9, minor_breaks = NULL) +
  coord_equal() +
  theme_minimal()

cv_dat %>%
  gather(type, metric, gam:cca) %>%
  mutate(srmse = map_dbl(metric, ~sum(.$srmse > 0.7))) %>%
  select(-metric) %>%
  arrange(srmse) %>%
    filter(srmse < (min(srmse) + sd(srmse))) %>%
    mutate(test = k_predictor + k_response) %>%
  arrange(test)

cv_dat %>%
  gather(type, metric, gam:cca) %>%
  mutate(sspb = map_dbl(metric, ~mean(.$sspb))) %>%
  select(-metric) %>%
  arrange(sspb) %>%
    filter(sspb < (min(sspb) + sd(sspb))) %>%
  mutate(test = k_predictor + k_response) %>%

cv_dat$gam[[1]]
```

#### Domain averages
```{r}
wus_stats <- prism_dat %>%
  left_join(areas, by = c("x", "y")) %>%
  group_by(year) %>%
  #mutate(covered = if_else(SWE >= 3, area, 0)) %>% # 3mm threshold
    mutate(covered = pmin(1, SWE / 3) * area) %>% # linear decline below 3mm
  summarise(SWE = sum(SWE * area), # units in megaliters (?)
            SCA = sum(covered))

mountains_stats <- prism_dat %>%
  left_join(areas, by = c("x", "y")) %>%
  inner_join(mountains_mask, by = c("x", "y")) %>%
  group_by(year, name) %>%
 # mutate(covered = if_else(SWE >= 3, area, 0)) %>%
  mutate(covered = pmin(1, SWE / 3) * area) %>%
  summarise(SWE = sum(SWE * area), 
            SCA = sum(covered))
```

```{r}
cv_recons <- cv_dat %>%
  mutate(cv = map(cv, ~left_join(., areas, by = c("x", "y")))) %>%
  unnest(cv) %>%
 # mutate(covered = if_else(SWE >= 3, area, 0)) %>%
      mutate(covered = pmin(1, SWE / 3) * area) %>% # linear decline below 3mm
  group_by(k_predictor, k_response, year, type) %>%
  summarise(SWE = sum(SWE * area), 
            SCA = sum(covered)) %>%
  left_join(wus_stats, by = 'year', suffix = c('_recon', '_obs'))
gc()
range_recons <- cv_dat %>%
  mutate(cv = map(cv, ~left_join(., areas, by = c("x", "y")) %>% 
                    inner_join(mountains_mask, by = c("x", "y")))) %>%
  unnest(cv) %>%
 # mutate(covered = if_else(SWE >= 3, area, 0)) %>%
      mutate(covered = pmin(1, SWE / 3) * area) %>% # linear decline below 3mm
  group_by(k_predictor, k_response, name, year) %>%
  summarise(SWE = sum(SWE * area),
            SCA = sum(covered)) %>%
  left_join(mountains_stats, by = c('year', 'name'), suffix = c('_recon', '_obs'))
gc()
```


```{r}
rmse_dat <- cv_recons %>%
      summarise(SWE_rmse = sqrt(mean((SWE_obs - SWE_recon) ^ 2)),
                SCA_rmse = sqrt(mean((SCA_obs - SCA_recon) ^ 2)))
```

The cross validation routine selects `r rmse_dat[[1, "k_response"]]` PRISM PCs and  `r rmse_dat[[1, "k_predictor"]]` CERA PCs 
```{r}
arrange(rmse_dat, SWE_rmse)
arrange(rmse_dat, SCA_rmse)

rmse_dat %>%
  ggplot(aes(k_predictor, k_response, fill = SWE_rmse)) +
  geom_tile() +
  scale_fill_viridis_c(direction = -1) +
  scale_x_continuous(breaks = 1:9, minor_breaks = NULL) +
  scale_y_continuous(breaks = 1:9, minor_breaks = NULL) +
  coord_equal() +
  theme_minimal()

rmse_dat %>%
ggplot(aes(k_predictor, k_response, fill = SCA_rmse)) +
  geom_tile() +
  scale_fill_viridis_c(direction = -1) +
  scale_x_continuous(breaks = 1:9, minor_breaks = NULL) +
  scale_y_continuous(breaks = 1:9, minor_breaks = NULL) +
  coord_equal() +
  theme_minimal()

(rmse_dat$SWE_rmse %>% sd )+ 17704851
```


```{r, fig.asp = .35}
t1 <- cv_recons %>% filter(k_response == 6, k_predictor == 8) %>%
  gather(type, value, SWE_recon:SCA_obs) %>%
  separate(type, c('var', 'type')) %>%
  mutate(name = 'Western US')

ggplot(t1, aes(year)) +
  geom_line(aes(y = value, color = type)) +
  scale_color_manual(values = c('black', 'red')) +
    facet_wrap(~var, scales = 'free_y') +
  theme_bw()
```


```{r, fig.width = 8}
g <- range_recons %>%
  filter(k_response == 4, k_predictor == 4) %>%
  select(-SCA_recon, -SCA_obs) %>%
  rename(recon = SWE_recon, obs = SWE_obs) %>%
  gather(type, SWE, recon:obs) %>%
  ggplot(aes(year)) +
  geom_line(aes(y = SWE, color = type)) +
  scale_color_manual(values = c('black', 'red')) +
  facet_wrap(~name, scales = 'free_y', ncol = 3) +
  theme_bw()

h <- range_recons %>%
  filter(k_response == 7, k_predictor == 9) %>%
  select(-SWE_recon, -SWE_obs) %>%
  rename(recon = SCA_recon, obs = SCA_obs) %>%
  gather(type, SCA, recon:obs) %>%
  ggplot(aes(year)) +
  geom_line(aes(y = SCA, color = type)) +
  scale_color_manual(values = c('black', 'red')) +
    facet_wrap(~name, scales = 'free_y', ncol = 3) +
  theme_bw()

g / h + plot_annotation(tag_levels = 'A')
```

```{r, echo = FALSE, eval = FALSE}
# trying to combine above?
t2 <- range_recons %>%
  filter(k_response == 4, k_predictor == 4) %>%
   gather(type, value, SWE_recon:SCA_obs) %>%
  separate(type, c('var', 'type'))

bind_rows(t1, t2) %>%
   ggplot(aes(year)) +
  geom_line(aes(y = value, color = type)) +
  scale_color_manual(values = c('black', 'red')) +
    facet_grid(var~name, scales = 'free_y') +
  theme_bw()
```


# Reconstruction

```{r}
recon_20c <- couple_patterns(get_patterns(cera_dat, 4), get_patterns(prism_dat, 6)) %>%
  predict_patterns(get_patterns(cera_dat, 4)) %>%
  reconstruct_field(get_patterns(prism_dat, 6), .)

recon_20c2 <-predict_cca(get_patterns(filter(cera_dat, year >=1982), 5), 
            get_patterns(filter(prism_dat, year <=2010), 4), 
            cera_dat,
            k = 4)
```

```{r}
cera_areas <- raster::area(cera) %>%
  as.data.frame(xy = TRUE)

cera_baseline <- cera_dat%>%
  left_join(cera_areas) %>%
  group_by(year) %>%
  summarise(SWE = sum(SWE* layer))
```

```{r}
delta_baseline <- delta(pred = filter(cera_dat, year >= 1982),
      obs = filter(prism_dat, year <= 2010),
      newdata = cera_dat)

delta_baseline2 <- left_join(delta_baseline, areas, by = c("x", "y")) %>%
  group_by(year) %>%
  summarise(SWE = sum(SWE * area))
```


```{r}
left_join(recon_20c, areas, by = c("x", "y")) %>%
  group_by(year) %>%
  summarise(SWE = sum(SWE * area)) %>%
  ggplot(aes(year, SWE)) +
  geom_line() +
      geom_line(data = wus_stats, color = 'red') +
        geom_line(data = cera_baseline, color = 'grey') +
  #geom_line(data = mutate(delta_baseline2, SWE = if_else(SWE > 500000000, 500000000, SWE)), color = 'grey') +
  labs(x = 'Year') +
  theme_bw()

left_join(recon_20c2, areas, by = c("x", "y")) %>%
  group_by(year) %>%
  summarise(SWE = sum(SWE * area)) %>%
  ggplot(aes(year, SWE)) +
  geom_line() +
      geom_line(data = wus_stats, color = 'red') +
  labs(x = 'Year') +
  theme_bw()

ggsave('20c_recon.png', height = 4, width = 6)
```



#### Local error
```{r}
scores <- cv_dat %>%
  mutate(errors = map(cv, ~get_errors(.) %>% group_by(x, y) %>% filter(median(SWE_recon) > 3 & median(SWE_obs) > 3) %>% # or should it only befiltering by obs?
  ungroup()),
        score_map = map(errors, ~group_by(., x,y) %>% get_scores),
         score_ts = map(errors, ~group_by(., year) %>% get_scores)) %>%
  select(-cv, -errors)
```

time

```{r}
scores %>% mutate(k = interaction(k_response, k_predictor)) %>%
  dplyr::select(k, score_ts) %>%
  unnest(score_ts) %>%
  dplyr::select(k, mdsa, year) %>%
  ggplot(aes(year, mdsa)) +
  geom_line(aes(color = k)) +
  scale_color_viridis_d() +
  theme_bw()
```

```{r}
plot_fun1 <- function(x, name) {
  ggplot(x, aes(k_predictor, k_response, fill = value)) +
  geom_tile() +
  scale_fill_viridis_c(direction = -1, name = name) +
  coord_equal() +
      scale_x_continuous(breaks = 1:9, minor_breaks = NULL) +
  scale_y_continuous(breaks = 1:9, minor_breaks = NULL) +
  theme_minimal()
}
tmp1 <- scores %>%
  select(k_response, k_predictor, score_ts) %>%
  unnest(score_ts) %>%
  group_by(k_response, k_predictor) %>%
  summarise_at(vars(me:rmsle), mean) %>%
  gather(metric, value, me:rmsle) %>%
group_by(metric) %>%
  nest %>%
  mutate(plots = map2(data, metric, plot_fun1))

tmp1$plots
```

space 

```{r}
tmp2 <- scores %>%
  select(k_response, k_predictor, score_map) %>%
  unnest(score_map) %>%
  select(k_response:y, rmse, mdsa, srmse, rmsle) %>%
  group_by(k_response, k_predictor) %>%
  summarise(rmse = mean(rmse), mdsa = mean(mdsa), srmse_avg = mean(srmse), rmsle = mean(rmsle), srmse7 = sum(srmse>.7, na.rm = TRUE)) %>%
  gather(metric, value, rmse:srmse7) %>%
group_by(metric) %>%
  nest %>%
  mutate(plots = map2(data, metric, plot_fun1))

tmp2$plots
```


# Paleo



## older stuff

```{r}
t7 <- prism_dat %>%
  filter(year <= 2010) %>%
  spread(year, SWE) %>%
  rasterFromXYZ()

eot_rmse <- (predict(telecon, eot1) + mean(t7) - t7)^2 %>%
  cellStats(stat = 'mean') %>%
  sqrt()

cca_rmse <- tele_dat %>%
  mutate(swe_pred = tele_pred * swe_sd + swe_mean,
         error = swe_pred - SWE) %>% 
  group_by(year) %>%
  summarise(rmse = sqrt(mean(error ^ 2))) 

gam_rmse <- gam_recon %>%
  left_join(prism_dat, by = c('x', 'y', 'year')) %>%
  mutate(error = SWE.x - SWE.y) %>%
  group_by(year) %>%
  summarise(rmse = sqrt(mean(error ^ 2))) 

left_join(gam_rmse, cca_rmse, by = 'year') %>%
  mutate(eot_rmse = eot_rmse) %>%
  gather(method, rmse, rmse.x:eot_rmse) %>%
  ggplot(aes(year, rmse)) +
  geom_line(aes(color = method))
```

So the gam is in part effective here because it resolves recent snow droughts ... I wonder if this is a global warming trend?
```{r}
tele_dat %>%
  filter(year == 2005 ) %>%
  ggplot(aes(x, y)) +
  geom_raster(aes(fill = anomaly)) +
  scale_fill_distiller(palette = 'RdBu', limits = c(-1100, 1100)) +
  facet_wrap(~year) +
  coord_quickmap()
```


```{r}
test2 <- tele.preds %>%
as_tibble() %>%
  bind_cols(t3, .) %>%
  rasterFromXYZ() 

plot(((test2 * calc(prism, sd) + mean(prism)) - prism )[[24]])
```

```{r}
plot(mean(prism) - prism)
mean(prism) - prism

tele.preds %>%
  as.tibble() %>%
  bind_cols(t3, .)
```
